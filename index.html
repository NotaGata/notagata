<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaGata - Masa 12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .selected-item { border-color: #10b981 !important; background-color: #f0fdf4; }
        .hidden-view { display: none; }
        .transition-all { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">

    <div id="view-landing" class="min-h-screen flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-12">
            <h1 class="text-5xl font-black tracking-tighter uppercase italic mb-2">NotaGata</h1>
            <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px]">Experien»õƒÉ digitalƒÉ la Masa 12</p>
        </div>

        <div class="w-full max-w-sm space-y-4">
            <button onclick="alert('OspƒÉtarul a fost notificat »ôi va ajunge la Masa 12 √Æn cel mai scurt timp!')" 
                    class="w-full py-6 bg-white border-2 border-slate-200 rounded-[2rem] shadow-sm flex items-center justify-center space-x-3 active:scale-95 transition-all">
                <span class="text-2xl">üîî</span>
                <span class="font-bold text-lg text-slate-700">CheamƒÉ OspƒÉtar</span>
            </button>

            <button onclick="showView('view-bill')" 
                    class="w-full py-12 bg-black text-white rounded-[2.5rem] shadow-2xl flex flex-col items-center justify-center space-y-3 active:scale-95 transition-all">
                <span class="text-3xl">üßæ</span>
                <span class="font-black text-2xl uppercase tracking-tight">Vezi Nota de PlatƒÉ</span>
                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Split Bill & Tips incluse</span>
            </button>
        </div>

        <p class="mt-20 text-[10px] text-slate-300 font-bold uppercase tracking-widest italic">Powered by NotaGata Technology</p>
    </div>

    <div id="view-bill" class="hidden-view min-h-screen p-6 max-w-md mx-auto">
        <header class="flex items-center justify-between mb-10">
            <button onclick="showView('view-landing')" class="text-slate-400 font-black text-xs uppercase tracking-widest">‚Üê √énapoi</button>
            <h2 id="rest-name" class="font-black text-xl italic uppercase tracking-tighter">Restaurant Demo</h2>
        </header>

        <section class="mb-8">
            <div class="flex justify-between items-end mb-4 px-1">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Alege ce plƒÉte»ôti</h3>
                <span class="text-[9px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-black uppercase">Split Bill Activ</span>
            </div>
            <div id="bill-items-container" class="space-y-3">
                <div class="animate-pulse bg-white h-16 rounded-2xl border border-slate-100"></div>
            </div>
        </section>

        <section class="mb-8 bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4 text-center">AdaugƒÉ un mul»õumesc (Tips)</h3>
            <div class="grid grid-cols-4 gap-2">
                <button onclick="setTip(0.10, this)" class="tip-btn py-3 border-2 border-slate-100 rounded-2xl font-black text-xs text-slate-500 transition-all hover:border-black">10%</button>
                <button onclick="setTip(0.12, this)" class="tip-btn py-3 border-2 border-slate-100 rounded-2xl font-black text-xs text-slate-500 transition-all hover:border-black">12%</button>
                <button onclick="setTip(0.15, this)" class="tip-btn py-3 border-2 border-slate-100 rounded-2xl font-black text-xs text-slate-500 transition-all hover:border-black">15%</button>
                <button onclick="setCustomTip()" class="tip-btn py-3 border-2 border-slate-100 rounded-2xl font-black text-xs text-slate-500 transition-all hover:border-black">SursƒÉ</button>
            </div>
        </section>

        <div class="sticky bottom-6 space-y-3 bg-slate-50 pt-2">
            <button onclick="alert('Func»õionalitate FacturƒÉ (CIF) va fi disponibilƒÉ √Æn cur√¢nd!')" 
                    class="w-full py-4 bg-slate-200/50 text-slate-500 font-black rounded-2xl text-[10px] uppercase tracking-widest">
                SolicitƒÉ FacturƒÉ FiscalƒÉ
            </button>
            
            <button id="pay-btn" onclick="processPayment()" 
                    class="w-full py-6 bg-emerald-500 text-white rounded-[2rem] shadow-xl shadow-emerald-200 flex justify-between items-center px-8 active:scale-95 transition-all">
                <div class="flex flex-col items-start">
                    <span class="font-black text-xs opacity-80 uppercase tracking-tighter">ConfirmƒÉ Plata</span>
                    <span id="ui-total-display" class="font-black text-2xl tracking-tighter">0.00 RON</span>
                </div>
                <span class="text-2xl font-light opacity-50">|</span>
                <span class="font-black text-lg">PAY</span>
            </button>
        </div>
    </div>

    <script>
        // INITIALIZARE CHEI
        const sb = supabase.createClient('https://etvbmlqvwmzppmuargaf.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0dmJtbHF2d216cHBtdWFyZ2FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNDA5OTEsImV4cCI6MjA4NTYxNjk5MX0.so_V_0cbtRrKqieL8NSTU0EC9t-kTy1WenNVutaNtcY');
        const stripe = Stripe('pk_test_51SwQE7Fh6VvPtCfai6TWSatQOqf7fHn29qxZHwlu8xAGNoAw3XTMcPqcUhn0fMTlbal0JXVUqjDFMNBi9xwqxY4100B3nQ5nJy');
        
        let selectedItemsIds = [];
        let currentProducts = [];
        let tipAmount = 0;

        // NAVIGARE
        function showView(viewId) {
            document.getElementById('view-landing').classList.add('hidden-view');
            document.getElementById('view-bill').classList.add('hidden-view');
            document.getElementById(viewId).classList.remove('hidden-view');
            window.scrollTo(0,0);
        }

        // INCARCARE DATE
        async function loadBill() {
            const { data } = await sb.from('bill_items').select('*');
            currentProducts = data || [];
            renderItems();
        }

        function renderItems() {
            const container = document.getElementById('bill-items-container');
            container.innerHTML = '';
            
            if (currentProducts.length === 0) {
                container.innerHTML = '<p class="text-center py-10 font-bold text-slate-400 italic">Nu sunt produse pe aceastƒÉ notƒÉ.</p>';
                return;
            }

            currentProducts.forEach(item => {
                const isSelected = selectedItemsIds.includes(item.id);
                const div = document.createElement('div');
                div.onclick = () => toggleItem(item.id);
                div.className = `p-5 bg-white border-2 ${isSelected ? 'selected-item border-emerald-500 shadow-md' : 'border-white shadow-sm'} rounded-[1.5rem] flex justify-between items-center transition-all cursor-pointer`;
                div.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="w-6 h-6 border-2 rounded-full ${isSelected ? 'bg-emerald-500 border-emerald-500' : 'border-slate-200'} flex items-center justify-center transition-all">
                            ${isSelected ? '<span class="text-white text-xs font-bold">‚úì</span>' : ''}
                        </div>
                        <span class="font-black text-slate-800 text-sm tracking-tight">${item.name}</span>
                    </div>
                    <span class="font-black text-slate-900">${item.price.toFixed(2)}</span>
                `;
                container.appendChild(div);
            });
            updateTotal();
        }

        function toggleItem(id) {
            if (selectedItemsIds.includes(id)) {
                selectedItemsIds = selectedItemsIds.filter(i => i !== id);
            } else {
                selectedItemsIds.push(id);
            }
            renderItems();
        }

        // LOGICA TIPS
        function setTip(percent, btn) {
            const baseTotal = calculateBaseTotal();
            tipAmount = baseTotal * percent;
            
            document.querySelectorAll('.tip-btn').forEach(b => {
                b.classList.remove('bg-black', 'text-white', 'border-black');
                b.classList.add('text-slate-500', 'border-slate-100');
            });
            
            btn.classList.add('bg-black', 'text-white', 'border-black');
            btn.classList.remove('text-slate-500', 'border-slate-100');
            
            updateTotal();
        }

        function setCustomTip() {
            const custom = prompt("Introdu suma bac»ôi»ôului (RON):");
            if(custom && !isNaN(custom)) {
                tipAmount = parseFloat(custom);
                updateTotal();
            }
        }

        function calculateBaseTotal() {
            return currentProducts
                .filter(item => selectedItemsIds.includes(item.id))
                .reduce((sum, item) => sum + item.price, 0);
        }

        function updateTotal() {
            const total = calculateBaseTotal() + tipAmount;
            document.getElementById('ui-total-display').innerText = total.toFixed(2) + " RON";
        }

        // PROCESARE PLATA
        async function processPayment() {
            const total = calculateBaseTotal() + tipAmount;
            if (total <= 0) return alert("VƒÉ rugƒÉm sƒÉ selecta»õi produsele pe care dori»õi sƒÉ le achita»õi!");

            const btn = document.getElementById('pay-btn');
            btn.disabled = true;
            btn.classList.add('opacity-50');
            btn.innerText = "SE PROCESEAZƒÇ...";

            try {
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        amount: total, 
                        restaurantName: "Demo Restaurant",
                        selectedItems: selectedItemsIds
                    }),
                });

                const session = await response.json();
                if (session.id) {
                    stripe.redirectToCheckout({ sessionId: session.id });
                } else {
                    throw new Error(session.error || "Eroare server");
                }
            } catch (err) {
                alert("Eroare: " + err.message);
                btn.disabled = false;
                btn.classList.remove('opacity-50');
                updateTotal();
            }
        }

        // REALTIME & INITIAL LOAD
        sb.channel('bill-v2').on('postgres_changes', { event: '*', schema: 'public', table: 'bill_items' }, () => loadBill()).subscribe();
        loadBill();
    </script>
</body>
</html>
